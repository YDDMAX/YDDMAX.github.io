<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="YDDMAX" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="code rush">
<meta property="og:type" content="website">
<meta property="og:title" content="YDDMAX">
<meta property="og:url" content="http://YDDMAX.github.io/index.html">
<meta property="og:site_name" content="YDDMAX">
<meta property="og:description" content="code rush">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="YDDMAX">
<meta name="twitter:description" content="code rush">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://YDDMAX.github.io/"/>





  <title> YDDMAX </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YDDMAX</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">代码奔腾</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://YDDMAX.github.io/2017/06/12/openjdk之编译经常出现的问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yunzhu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YDDMAX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/12/openjdk之编译经常出现的问题/" itemprop="url">
                  openjdk之编译经常出现的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-12T00:41:19+08:00">
                2017-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jvm/" itemprop="url" rel="index">
                    <span itemprop="name">jvm</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>openjdk编译过程中，因为系统环境和openjdk版本等问题，会出现各种问题。本文主要列出两个经常出现的问题及解决办法。</p>
<h1 id="time-is-more-than-10-years-from-present"><a href="#time-is-more-than-10-years-from-present" class="headerlink" title="time is more than 10 years from present"></a>time is more than 10 years from present</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Error: time is more than <span class="number">10</span> years from present: <span class="number">1136059200000</span></div><div class="line">Java.lang.RuntimeException: time is more than <span class="number">10</span> years from present: <span class="number">1136059200000</span></div><div class="line">  at build.tools.generatecurrencydata.GenerateCurrencyData.makeSpecialCaseEntry(GenerateCurrencyData.java:<span class="number">285</span>)</div><div class="line">  at build.tools.generatecurrencydata.GenerateCurrencyData.buildMainAndSpecialCaseTables(GenerateCurrencyData.java:<span class="number">225</span>)</div><div class="line">  at build.tools.generatecurrencydata.GenerateCurrencyData.main(GenerateCurrencyData.java:<span class="number">154</span>)</div></pre></td></tr></table></figure>
<p>解决办法:</p>
<p>修改CurrencyData.properties（路径：jdk/src/share/classes/java/util/CurrencyData.properties）</p>
<p>修改108行<br><code>AZ=AZM;2009-12-31-20-00-00;AZN</code><br>修改381行<br><code>MZ=MZM;2009-06-30-22-00-00;MZN</code><br>修改443行<br><code>RO=ROL;2009-06-30-21-00-00;RON</code><br>修改535行<br><code>TR=TRL;2009-12-31-22-00-00;TRY</code><br>修改561行<br><code>VE=VEB;2009-01-01-04-00-00;VEF</code></p>
<h1 id="OS-is-not-supported-Linux-…-4-0-0-1-amd64-…"><a href="#OS-is-not-supported-Linux-…-4-0-0-1-amd64-…" class="headerlink" title="OS is not supported: Linux … 4.0.0-1-amd64 …"></a>OS is not supported: Linux … 4.0.0-1-amd64 …</h1><p>openjdk在编译时检查linux的内核版本，之前的检查代码没有检查4.x版本(那个时候还没有这个版本的内核)，导致出错。我们只需要在对应的检查代码里加上即可。</p>
<p>在文件hotspot/make/linux/Makefile中，修改如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-SUPPORTED_OS_VERSION = 2.4% 2.5% 2.6% 3%</div><div class="line">+SUPPORTED_OS_VERSION = 2.4% 2.5% 2.6% 3% 4%</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://YDDMAX.github.io/2017/06/12/openjdk8之编译和debug/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yunzhu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YDDMAX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/12/openjdk8之编译和debug/" itemprop="url">
                  openjdk8之编译和debug
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-12T00:26:56+08:00">
                2017-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jvm/" itemprop="url" rel="index">
                    <span itemprop="name">jvm</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>系统环境为ubuntu 16.04，uname -a:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Linux ddy-Aspire-V5-573G 4.4.0-21-generic <span class="comment">#37-Ubuntu SMP Mon Apr 18 18:33:37 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span></div></pre></td></tr></table></figure></p>
<p>在本文中，要编译的openjdk版本为:<a href="https://pan.baidu.com/s/1mhLHkc4" target="_blank" rel="external">openjdk-8u40-src-b25-10_feb_2015</a>。<br>尝试了编译<a href="https://pan.baidu.com/s/1jI1cGNc" target="_blank" rel="external">openjdk-8-src-b132-03_mar_2014</a>，但是失败。网上说,因为ubuntu16.04较新，但是该版本的JDK较老，所以失败。</p>
<p>下面说明编译过程。</p>
<h1 id="make版本"><a href="#make版本" class="headerlink" title="make版本"></a>make版本</h1><p>OpenJDK8可以使用”config &amp;&amp; make”编译构建，不再使用Ant和ALT_ *环境变量来配置构建。<br>不过需要GNU make 3.81或更新的版本</p>
<h1 id="安装引导JDK"><a href="#安装引导JDK" class="headerlink" title="安装引导JDK"></a>安装引导JDK</h1><p>我使用的引导JDK是<a href="https://pan.baidu.com/s/1hr6qkOO" target="_blank" rel="external">jdk-7u76-linux-x64</a>。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">java version <span class="string">"1.6.0_45"</span></div><div class="line">Java(TM) SE Runtime Environment (build 1.6.0_45-b06)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 20.45-b01, mixed mode)</div></pre></td></tr></table></figure></p>
<h1 id="安装编译工具类库："><a href="#安装编译工具类库：" class="headerlink" title="安装编译工具类库："></a>安装编译工具类库：</h1><p>安装gcc、g++、make等<br><code>sudo apt-get install build-essential</code><br>安装XRender<br><code>sudo apt-get install libxrender-dev</code><br><code>sudo apt-get install xorg-dev</code><br>安装alsa<br><code>sudo apt-get install libasound2-dev</code><br>Cups<br><code>sudo apt-get install libcups2-dev</code><br>安装零碎的工具包<br><code>sudo apt-get install gawk zip libxtst-dev libxi-dev libxt-dev</code></p>
<h1 id="建立编译脚本"><a href="#建立编译脚本" class="headerlink" title="建立编译脚本"></a>建立编译脚本</h1><p>–with-boot-jdk：指定引导JDK所在目录，以防其他安装的JDK影响（本机上以前安装了JDK8，并配置了JAVA_HOME指向JDK8）；<br>–with-target-bits：指定编译64位系统的JDK；</p>
<p>为可以进行源码调试，再指定下面三个参数：<br>–with-debug-level=slowdebug：指定可以生成最多的调试信息；<br>–enable-debug-symbols ZIP_DEBUGINFO_FILES=0：生成调试的符号信息，并且不压缩；<br>在openjdk目录下新建build.sh，内容如下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> openjdk  </div><div class="line">bash ./configure --with-target-bits=64 --with-boot-jdk=/usr/java/jdk1.7.0_80/ --with-debug-level=slowdebug --<span class="built_in">enable</span>-debug-symbols ZIP_DEBUGINFO_FILES=0  </div><div class="line">make all ZIP_DEBUGINFO_FILES=0</div></pre></td></tr></table></figure></p>
<h1 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h1><p>执行<code>./build.sh</code><br>编译完成是这样的：<br><img src="http://oqxil93b6.bkt.clouddn.com/images/openjdk/opjdk-8u40-compile-success.png" alt="openjdk8-compile-success.png"></p>
<h1 id="用GDB测试是否能debug"><a href="#用GDB测试是否能debug" class="headerlink" title="用GDB测试是否能debug"></a>用GDB测试是否能debug</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">ddy@ddy-Aspire-V5-573G ~/openjdk-compile/openjdk-8u40-src-b25-10_feb_2015/openjdk/build/linux-x86_64-normal-server-slowdebug/jdk/bin $ ./java -version</div><div class="line">openjdk version <span class="string">"1.8.0-internal-debug"</span></div><div class="line">OpenJDK Runtime Environment (build 1.8.0-internal-debug-ddy_2017_06_11_23_26-b00)</div><div class="line">OpenJDK 64-Bit Server VM (build 25.40-b25-debug, mixed mode)</div><div class="line">ddy@ddy-Aspire-V5-573G ~/openjdk-compile/openjdk-8u40-src-b25-10_feb_2015/openjdk/build/linux-x86_64-normal-server-slowdebug/jdk/bin $ <span class="built_in">export</span> CLASSPATH=.:/home/</div><div class="line">ddy/java_src</div><div class="line">ddy@ddy-Aspire-V5-573G ~/openjdk-compile/openjdk-8u40-src-b25-10_feb_2015/openjdk/build/linux-x86_64-normal-server-slowdebug/jdk/bin $ gdb --args java FileChann</div><div class="line">elTest</div><div class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1</div><div class="line">Copyright (C) 2016 Free Software Foundation, Inc.</div><div class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</div><div class="line">This is free software: you are free to change and redistribute it.</div><div class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></div><div class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</div><div class="line">This GDB was configured as <span class="string">"x86_64-linux-gnu"</span>.</div><div class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</div><div class="line">For bug reporting instructions, please see:</div><div class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</div><div class="line">Find the GDB manual and other documentation resources online at:</div><div class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</div><div class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</div><div class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>...</div><div class="line">Reading symbols from java...done.</div><div class="line">(gdb) <span class="built_in">break</span> init.cpp:95</div><div class="line">No <span class="built_in">source</span> file named init.cpp.</div><div class="line">Make breakpoint pending on future shared library load? (y or [n]) y</div><div class="line">Breakpoint 1 (init.cpp:95) pending.</div><div class="line">(gdb) run</div><div class="line">Starting program: /home/ddy/openjdk-compile/openjdk-8u40-src-b25-10_feb_2015/openjdk/build/linux-x86_64-normal-server-slowdebug/jdk/bin/java FileChannelTest</div><div class="line">[Thread debugging using libthread_db enabled]</div><div class="line">Using host libthread_db library <span class="string">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span>.</div><div class="line">[New Thread 0x7ffff7fc8700 (LWP 9311)]</div><div class="line">[Switching to Thread 0x7ffff7fc8700 (LWP 9311)]</div><div class="line"></div><div class="line">Thread 2 <span class="string">"java"</span> hit Breakpoint 1, init_globals ()</div><div class="line">    at /home/ddy/openjdk-compile/openjdk-8u40-src-b25-10_feb_2015/openjdk/hotspot/src/share/vm/runtime/init.cpp:95</div><div class="line">95	jint <span class="function"><span class="title">init_globals</span></span>() &#123;</div><div class="line">(gdb) l</div><div class="line">90	  chunkpool_init();</div><div class="line">91	  perfMemory_init();</div><div class="line">92	&#125;</div><div class="line">93	</div><div class="line">94	</div><div class="line">95	jint <span class="function"><span class="title">init_globals</span></span>() &#123;</div><div class="line">96	  HandleMark hm;</div><div class="line">97	  management_init();</div><div class="line">98	  bytecodes_init();</div><div class="line">99	  classLoader_init();</div><div class="line">(gdb) quit</div><div class="line">A debugging session is active.</div><div class="line"></div><div class="line">	Inferior 1 [process 9307] will be killed.</div><div class="line"></div><div class="line">Quit anyway? (y or n) y</div><div class="line">ddy@ddy-Aspire-V5-573G ~/openjdk-compile/openjdk-8u40-src-b25-10_feb_2015/openjdk/build/linux-x86_64-normal-server-slowdebug/jdk/bin $</div></pre></td></tr></table></figure>
<p><a href="https://yddmax.github.io/2017/06/12/openjdk%E4%B9%8B%E7%BC%96%E8%AF%91%E7%BB%8F%E5%B8%B8%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98/">openjdk之编译经常出现的问题</a><br><a href="https://yddmax.github.io/2017/06/11/openjdk7%E4%B9%8B%E7%BC%96%E8%AF%91%E5%92%8Cdebug/">openjdk7的编译和debug</a><br>编译主要参考：<a href="https://ayonel.me/index.php/2017/01/05/compile_openjdk/" target="_blank" rel="external">ubuntu14.04 编译openjdk7</a><br>debug主要参考：<a href="http://blog.csdn.net/tjiyu/article/details/53725247" target="_blank" rel="external">CentOS上编译OpenJDK8源码 以及 在eclipse上调试HotSpot虚拟机源码</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://YDDMAX.github.io/2017/06/11/openjdk7之编译和debug/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yunzhu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YDDMAX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/11/openjdk7之编译和debug/" itemprop="url">
                  openjdk7之编译和debug
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-11T23:53:55+08:00">
                2017-06-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jvm/" itemprop="url" rel="index">
                    <span itemprop="name">jvm</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>为了更好的学习JDK、HotSpot等源码，需要能debug JDK、HotSpot等源码。本文主要讲述，怎么编译openjdk并debug相关源码。<br>在本文中，要编译的openjdk:<a href="https://pan.baidu.com/s/1bFVRwq" target="_blank" rel="external">openjdk-7u40-fcs-src-b43-26_aug_2013.zip</a><br>系统环境为ubuntu 16.04，uname -a:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Linux ddy-Aspire-V5-573G 4.4.0-21-generic <span class="comment">#37-Ubuntu SMP Mon Apr 18 18:33:37 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span></div></pre></td></tr></table></figure></p>
<h1 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h1><ol>
<li>下载源代码<br>openjdk的源码可以通过hg方式下载。<br>也可以从此处下载：<a href="https://pan.baidu.com/s/1qXMoWfM" target="_blank" rel="external">openjdk源码</a></li>
<li><p>安装引导JDK<br>因为JDK中有很多代码是Java自身实现的，所以还需要一个已经安装在本机上可用的JDK，叫做“Bootstrap JDK”。我所选用的Bootstarp JDK是JDK1.6.0_45。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">java version <span class="string">"1.6.0_45"</span></div><div class="line">Java(TM) SE Runtime Environment (build 1.6.0_45-b06)</div><div class="line">Java HotSpot(TM) Server VM (build 20.45-b01, mixed mode)</div></pre></td></tr></table></figure>
<p>JDK1.6.0_45下载地址：<a href="https://pan.baidu.com/s/1eStdxq6" target="_blank" rel="external">jdk1.6.0_45.tar.gz</a></p>
</li>
<li>安装编译前的依赖环境<br>安装gcc、g++、make等<br><code>sudo apt-get install build-essential</code><br>安装ant 1.7以上<br><code>sudo apt-get install ant</code><br>安装XRender<br><code>sudo apt-get install libxrender-dev</code><br><code>sudo apt-get install xorg-dev</code><br>安装alsa<br><code>sudo apt-get install libasound2-dev</code><br>Cups<br><code>sudo apt-get install libcups2-dev</code><br>安装零碎的工具包<br><code>sudo apt-get install gawk zip libxtst-dev libxi-dev libxt-dev</code></li>
</ol>
<p>４. 配置编译脚本<br>将你的openjdk解压后，并进入该文件夹。比如我的是在/home/ddy/openjdk-compile/openjdk-7u40-fcs-b43-26/openjdk<br>下。新建一个build.sh，并添加如下内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> LANG=C</div><div class="line"><span class="comment">#将一下两项设置为你的BootstrapJDK安装目录</span></div><div class="line"><span class="built_in">export</span> ALT_BOOTDIR=/home/ddy/jdk1.6.0_45</div><div class="line"><span class="built_in">export</span> ALT_JDK_IMPORT_PATH=/home/ddy/jdk1.6.0_45</div><div class="line"><span class="comment">#允许自动下载依赖包</span></div><div class="line"><span class="built_in">export</span> ALLOW_DOWNLOADS=<span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">#使用预编译头文件，以提升便以速度</span></div><div class="line"><span class="built_in">export</span> USE_PRECOMPILED_HEADER=<span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">#要编译的内容，我只选择了LANGTOOLS、HOTSPOT以及JDK</span></div><div class="line"><span class="built_in">export</span> BUILD_LANGTOOLS=<span class="literal">true</span></div><div class="line"><span class="built_in">export</span> BUILD_JAXP=<span class="literal">false</span></div><div class="line"><span class="built_in">export</span> BUILD_JAXWS=<span class="literal">false</span></div><div class="line"><span class="built_in">export</span> BUILD_CORBA=<span class="literal">false</span></div><div class="line"><span class="built_in">export</span> BUILD_HOSTPOT=<span class="literal">true</span></div><div class="line"><span class="built_in">export</span> BUILD_JDK=<span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">#要编译的版本</span></div><div class="line"><span class="built_in">export</span> SKIP_DEBUG_BUILD=<span class="literal">false</span></div><div class="line"><span class="built_in">export</span> SKIP_FASTDEBUG_BUILD=<span class="literal">true</span></div><div class="line"><span class="built_in">export</span> DEBUG_NAME=debug</div><div class="line"></div><div class="line"><span class="comment">#避免javaws和浏览器Java插件等的build</span></div><div class="line">BUILD_DEPLOY=<span class="literal">false</span></div><div class="line"></div><div class="line"><span class="comment">#不build安装包</span></div><div class="line">BUILD_INSTALL=<span class="literal">false</span></div><div class="line"></div><div class="line"><span class="comment">#包含全部的调试信息</span></div><div class="line"><span class="built_in">export</span>  ENABLE_FULL_DEBUG_SYMBOLS=1</div><div class="line"><span class="comment">#调试信息是否压缩，如果配置为１,libjvm.debuginfo会被压缩成libjvm.diz,将不能被debug。</span></div><div class="line"><span class="built_in">export</span>  ZIP_DEBUGINFO_FILES=0</div><div class="line"><span class="comment">#用于编译线程数</span></div><div class="line"><span class="built_in">export</span>  HOTSPOT_BUILD_JOBS=3</div><div class="line"></div><div class="line"><span class="comment">#设置存放编译结果的目录</span></div><div class="line"><span class="comment">#export ALT_OUTPUTDIR=/home/ddy/openjdk/7/build</span></div><div class="line"></div><div class="line"><span class="built_in">unset</span> CLASSPATH</div><div class="line"><span class="built_in">unset</span> JAVA_HOME</div><div class="line">make sanity</div><div class="line">DEBUG_BINARIES=<span class="literal">true</span> make 2&gt;&amp;1</div></pre></td></tr></table></figure></p>
<p>５. 开始编译<br>在openjdk目录下，运行build.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chmod +x build.sh</div><div class="line">./build.sh</div></pre></td></tr></table></figure>
<p>最后编译耗时将近2分钟。编译完成输出如下信息：<br><img src="http://oqxil93b6.bkt.clouddn.com/images/openjdk/compile-success.png" alt="compile-success"><br>此时openjdk就编译完成了，编译的输出在<code>/home/ddy/openjdk-compile/openjdk-7u40-fcs-b43-26/openjdk/build/</code>下。<br>进入<code>/home/ddy/openjdk-compile/openjdk-7u40-fcs-b43-26/openjdk/build/linux-amd64-debug/j2re-image/bin
n</code>，执行<br><code>./java -version</code><br>输出的java版本信息将是带着你的机器用户名，我的输出是：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">openjdk version <span class="string">"1.7.0-internal-debug"</span></div><div class="line">OpenJDK Runtime Environment (build 1.7.0-internal-debug-ddy_2017_06_10_22_30-b00)</div><div class="line">OpenJDK 64-Bit Server VM (build 24.0-b56-jvmg, mixed mode)</div></pre></td></tr></table></figure></p>
<h1 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h1><p>编译完成了之后，就可以对JDK源码和HotSpot源码等进行debug了。</p>
<h2 id="JDK"><a href="#JDK" class="headerlink" title="JDK"></a>JDK</h2><p>首先是JDK源码，在build目录下编译生成的jdk里面的jar包都是可编译的了，直接把eclipse的JDK或者JRE换成编译成功的JDK或者JRE即可。</p>
<h2 id="HotSpot"><a href="#HotSpot" class="headerlink" title="HotSpot"></a>HotSpot</h2><p>注意，如果不能进入断点，出现以下类似信息：<br>      <code>Missing separate debuginfo for/root/openjdk/build/linux-x86_64-normal-server-slowdebug/jdk/lib/amd64/server/libjvm.so</code><br>是因为在编译时因为编译配置项不正确而没有生成调试的符号信息，或生成后被压缩为”libjvm.diz”了，所以无法找到。如果是因为没有编译时没有生成调试信息，需要修改编译配置并重新编译。对于被压缩的情况，可以去到”libjvm.so”所在目录</p>
<ul>
<li>然后解压：unzip libjvm.diz                </li>
<li>解压出来：libjvm.debuginfo</li>
</ul>
<p>如果在编译时，把配置信息修改如下，则不会出现不能上述问题。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#包含全部的调试信息</span></div><div class="line"><span class="built_in">export</span>  ENABLE_FULL_DEBUG_SYMBOLS=1</div><div class="line"><span class="comment">#调试信息是否压缩，如果配置为１,libjvm.debuginfo会被压缩成libjvm.diz,将不能被debug。</span></div><div class="line"><span class="built_in">export</span>  ZIP_DEBUGINFO_FILES=0</div></pre></td></tr></table></figure></p>
<h3 id="使用GDB"><a href="#使用GDB" class="headerlink" title="使用GDB"></a>使用GDB</h3><p> 参考：<a href="http://blog.csdn.net/tjiyu/article/details/53725247" target="_blank" rel="external">CentOS上编译OpenJDK8源码 以及 在eclipse上调试HotSpot虚拟机源码</a></p>
<h3 id="使用eclipse"><a href="#使用eclipse" class="headerlink" title="使用eclipse"></a>使用eclipse</h3><ol>
<li><p>生成要运行的JAVA类。<br>首先在<code>/home/ddy/src/java-src</code>目录下建立要运行的FileChannelTest.java，这个类在写文件时调用了JDK的native方法，其代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.RandomAccessFile;</div><div class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</div><div class="line"><span class="keyword">import</span> java.nio.channels.FileChannel;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileChannelTest</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">           FileChannel channel=<span class="keyword">new</span> RandomAccessFile(<span class="string">"test.txt"</span>,<span class="string">"rw"</span>).getChannel();</div><div class="line">           ByteBuffer buffer=ByteBuffer.allocate(<span class="number">1000</span>);</div><div class="line">           channel.write(buffer);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后对其进行编译,运行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ddy@ddy-Aspire-V5-573G ~ $ <span class="built_in">cd</span> src/java-src/</div><div class="line">ddy@ddy-Aspire-V5-573G ~/src/java-src $ <span class="built_in">pwd</span></div><div class="line">/home/ddy/src/java-src</div><div class="line">ddy@ddy-Aspire-V5-573G ~/src/java-src $ /home/ddy/openjdk-compile/openjdk-7u40-fcs-b43-26/openjdk/build/linux-amd64-debug/j2sdk-image/bin/javac FileChannelTest.java</div></pre></td></tr></table></figure>
</li>
<li><p>下载eclipse，安装C/C++插件<br>到官网选择一个合适的eclipse下载，因为本人主要进行JAVA开发，所以下载的是j2EE版本，这个版本没有C/C++的功能。不过可以安装插件使其支持C/C++功能。”help -&gt; Eclipse Maketplace”,搜索”c++”找到Eclipse C++ IDE..安装。安装后，就可以转到C++开发视图界面了。</p>
</li>
<li>导入hotspot工程<br>File-&gt; New -&gt; Makefile Project With Existing Code<br>在界面中:<br>   Project Name：openjdk（这个可以自己选择）<br>   Existing Code Location：/root/openjdk<br>   Toolchain：选Linux GCC，然后按Finish.     </li>
<li>配置源码调试     </li>
</ol>
<ul>
<li>右键工程 -&gt; Debug As -&gt; Debug Configurations -&gt; 右键左边的C/C++ Application -&gt; New -&gt; 进入Main选项卡；<br>在选项卡中:<pre><code>Project：openjdk（选择导入的openjdk工程）
C/C++ Application：``/home/ddy/openjdk-compile/openjdk-7u40-fcs-b43-26/openjdk/build/linux-amd64-debug/j2sdk-image/bin/java``（编译生成的openjdk虚拟机入口）
Disable auto build：因为不再在eclipse里面编译hotspot源码,所以这里选上它；
</code></pre></li>
<li>然后切换到Arguments选项卡, 输入Java的参数, 这里填上 “FileChannelTest”也就是我们要执行的JAVA程序。</li>
<li>然后切换到Environment选项卡, 添加变量：<br><code>JAVA_HOME=/home/ddy/openjdk-compile/openjdk-7u40-fcs-b43-26/openjdk/build/linux-amd64-debug/j2sdk-image</code>（编译生成JDK所在目录）<br><code>CLASSPATH=.:/home/ddy/src/java-src</code> (FileChannelTest.java文件所在目录)<br>点击下面的Apply保存；</li>
<li><p>断点Debug<br>　下面分别在源码上打两个断点：</p>
<ul>
<li>init.cpp(/home/ddy/openjdk-compile/openjdk-7u40-fcs-b43-26/openjdk/hotspot/src/share/vm/runtime目录下)      95行</li>
<li>FileDispatchImpl.c(/home/ddy/openjdk-compile/openjdk-7u40-fcs-b43-26/openjdk/jdk/src/solaris/native/sun/nio/ch目录下)    107行</li>
</ul>
</li>
</ul>
<p>然后开始debug。<br>首先是第一个断点：<br><img src="http://oqxil93b6.bkt.clouddn.com/images/openjdk/init.cpp-95.png" alt="init.cpp-95.png"></p>
<p>F8进行到下一个断电点：</p>
<p><img src="http://oqxil93b6.bkt.clouddn.com/images/openjdk/FileDispatcherImpl-write.c.jpg" alt="FileDispatcherImpl-write.c.png"></p>
<p>从上图可以看到,FileChannel.write()最后调用的是write()操作系统调用。<br>所以，大家现在可以随便debug　HotSpot的源码和JDK的native源码了。酷！</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://yddmax.github.io/2017/06/12/openjdk%E4%B9%8B%E7%BC%96%E8%AF%91%E7%BB%8F%E5%B8%B8%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98/">openjdk之编译经常出现的问题</a><br><a href="https://yddmax.github.io/2017/06/12/openjdk8%E4%B9%8B%E7%BC%96%E8%AF%91%E5%92%8Cdebug/">openjdk8的编译和debug</a><br>编译主要参考：<a href="https://ayonel.me/index.php/2017/01/05/compile_openjdk/" target="_blank" rel="external">ubuntu14.04 编译openjdk7</a><br>debug主要参考：<a href="http://blog.csdn.net/tjiyu/article/details/53725247" target="_blank" rel="external">CentOS上编译OpenJDK8源码 以及 在eclipse上调试HotSpot虚拟机源码</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://YDDMAX.github.io/2017/06/08/Buffer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yunzhu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YDDMAX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/08/Buffer/" itemprop="url">
                  Buffer
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-08T00:13:07+08:00">
                2017-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本机环境：<br><code>Linux  4.4.0-21-generic #37-Ubuntu SMP Mon Apr 18 18:33:37 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</code></p>
<h1 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h1><p> Buffer的类图如下：</p>
<p><img src="http://oqxil93b6.bkt.clouddn.com/images/IO/buffer-calss.png" alt="Buffer类图"></p>
<p>除了Boolean，其他基本数据类型都有对应的Buffer，但是只有ByteBuffer才能和Channel交互。<strong>只有ByteBuffer才能产生Direct的buffer</strong>，其他数据类型的Buffer只能产生Heap类型的Buffer。ByteBuffer可以产生其他数据类型的视图Buffer，如果ByteBuffer本身是Direct的，<strong>则产生的各视图Buffer也是Direct的</strong>。</p>
<h2 id="Direct和Heap类型Buffer的本质"><a href="#Direct和Heap类型Buffer的本质" class="headerlink" title="Direct和Heap类型Buffer的本质"></a>Direct和Heap类型Buffer的本质</h2><p>首选说说JVM是怎么进行IO操作的。</p>
<p>JVM在需要通过操作系统调用完成IO操作，比如可以通过read系统调用完成文件的读取。read的原型是：<code>ssize_t read(int fd,void *buf,size_t nbytes)</code>，和其他的IO系统调用类似，一般需要缓冲区作为其中一个参数，该缓冲区要求是连续的。</p>
<p>Buffer分为Direct和Heap两类，下面分别说明这两类buffer。</p>
<h3 id="Heap"><a href="#Heap" class="headerlink" title="Heap"></a>Heap</h3><p>Heap类型的Buffer存在于JVM的堆上，这部分内存的回收与整理和普通的对象一样。Heap类型的Buffer对象都包含一个对应基本数据类型的数组属性（比如：final **[] hb），数组才是Heap类型Buffer的底层缓冲区。<br>但是Heap类型的Buffer不能作为缓冲区参数直接进行系统调用，主要因为下面两个原因。</p>
<ul>
<li>JVM在GC时可能会移动缓冲区（复制-整理），缓冲区的地址不固定。</li>
<li>系统调用时，缓冲区需要是连续的，但是数组可能不是连续的（JVM的实现没要求连续）。</li>
</ul>
<p>所以使用Heap类型的Buffer进行IO时，JVM需要产生一个临时Direct类型的Buffer，然后进行数据复制，再使用临时Direct的Buffer作为参数进行操作系统调用。这造成很低的效率，主要是因为两个原因：</p>
<ul>
<li>需要把数据从Heap类型的Buffer里面复制到临时创建的Direct的Buffer里面。</li>
<li>可能产生大量的Buffer对象，从而提高GC的频率。<strong>所以在IO操作时，可以通过重复利用Buffer进行优化。</strong></li>
</ul>
<h3 id="Direct"><a href="#Direct" class="headerlink" title="Direct"></a>Direct</h3><p>Direct类型的buffer，不存在于堆上，而是JVM通过malloc直接分配的一段连续的内存，这部分内存成为直接内存，JVM进行IO系统调用时使用的是直接内存作为缓冲区。<br><code>-XX:MaxDirectMemorySize</code>，通过这个配置可以设置允许分配的最大直接内存的大小（MappedByteBuffer分配的内存不受此配置影响）。<br>直接内存的回收和堆内存的回收不同，如果直接内存使用不当，很容易造成OutOfMemoryError。JAVA没有提供显示的方法去主动释放直接内存，sun.misc.Unsafe类可以进行直接的底层内存操作，通过该类可以主动释放和管理直接内存。<strong>同理，也应该重复利用直接内存以提高效率。</strong></p>
<h2 id="MappedByteBuffer和DirectByteBuffer之间的关系"><a href="#MappedByteBuffer和DirectByteBuffer之间的关系" class="headerlink" title="MappedByteBuffer和DirectByteBuffer之间的关系"></a>MappedByteBuffer和DirectByteBuffer之间的关系</h2><blockquote>
<p><strong>This is a little bit backwards: By rights MappedByteBuffer should be a subclass of DirectByteBuffer, but to keep the spec clear and simple, and for optimization purposes, it’s easier to do it the other way around.This works because DirectByteBuffer is a package-private class.</strong>（本段话摘自MappedByteBuffer的源码）</p>
</blockquote>
<p>实际上，MappedByteBuffer属于映射buffer（自己看看虚拟内存），但是DirectByteBuffer只是说明该部分内存是JVＭ在直接内存区分配的连续缓冲区，并不一是映射的。也就是说MappedByteBuffer应该是DirectByteBuffer的子类，但是为了方便和优化，把MappedByteBuffer作为了DirectByteBuffer的父类。另外，虽然MappedByteBuffer在逻辑上应该是DirectByteBuffer的子类，而且MappedByteBuffer的内存的GC和直接内存的GC类似（和堆GC不同），但是分配的MappedByteBuffer的大小不受-XX:MaxDirectMemorySize参数影响。<br>MappedByteBuffer封装的是内存映射文件操作，也就是只能进行文件IO操作。MappedByteBuffer是根据mmap产生的映射缓冲区，这部分缓冲区被映射到对应的文件页上，属于直接内存在用户态，通过MappedByteBuffer可以直接操作映射缓冲区，而这部分缓冲区又被映射到文件页上，操作系统通过对应内存页的调入和调出完成文件的写入和写出。</p>
<h1 id="MappedByteBuffer"><a href="#MappedByteBuffer" class="headerlink" title="MappedByteBuffer"></a>MappedByteBuffer</h1><p> 通过<code>FileChannel.map(MapMode mode,long position, long size)</code>得到MappedByteBuffer，下面结合源码说明MappedByteBuffer的产生过程。</p>
<p><code>FileChannel.map</code>的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> MappedByteBuffer <span class="title">map</span><span class="params">(MapMode mode, <span class="keyword">long</span> position, <span class="keyword">long</span> size)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException</div><div class="line">    &#123;</div><div class="line">        ensureOpen();</div><div class="line">        <span class="keyword">if</span> (position &lt; <span class="number">0L</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Negative position"</span>);</div><div class="line">        <span class="keyword">if</span> (size &lt; <span class="number">0L</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Negative size"</span>);</div><div class="line">        <span class="keyword">if</span> (position + size &lt; <span class="number">0</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Position + size overflow"</span>);</div><div class="line">        <span class="comment">//最大2G</span></div><div class="line">        <span class="keyword">if</span> (size &gt; Integer.MAX_VALUE)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Size exceeds Integer.MAX_VALUE"</span>);</div><div class="line">        <span class="keyword">int</span> imode = -<span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (mode == MapMode.READ_ONLY)</div><div class="line">            imode = MAP_RO;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mode == MapMode.READ_WRITE)</div><div class="line">            imode = MAP_RW;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (mode == MapMode.PRIVATE)</div><div class="line">            imode = MAP_PV;</div><div class="line">        <span class="keyword">assert</span> (imode &gt;= <span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span> ((mode != MapMode.READ_ONLY) &amp;&amp; !writable)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NonWritableChannelException();</div><div class="line">        <span class="keyword">if</span> (!readable)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NonReadableChannelException();</div><div class="line"></div><div class="line">        <span class="keyword">long</span> addr = -<span class="number">1</span>;</div><div class="line">        <span class="keyword">int</span> ti = -<span class="number">1</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            begin();</div><div class="line">            ti = threads.add();</div><div class="line">            <span class="keyword">if</span> (!isOpen())</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            <span class="comment">//size()返回实际的文件大小</span></div><div class="line">            <span class="comment">//如果实际文件大小不符合，则增大文件的大小，文件的大小被改变，文件增大的部分默认设置为0。</span></div><div class="line">            <span class="keyword">if</span> (size() &lt; position + size) &#123; <span class="comment">// Extend file size</span></div><div class="line">                <span class="keyword">if</span> (!writable) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Channel not open for writing "</span> +</div><div class="line">                        <span class="string">"- cannot extend file to required size"</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">int</span> rv;</div><div class="line">                <span class="keyword">do</span> &#123;</div><div class="line">                   <span class="comment">//增大文件的大小</span></div><div class="line">                    rv = nd.truncate(fd, position + size);</div><div class="line">                &#125; <span class="keyword">while</span> ((rv == IOStatus.INTERRUPTED) &amp;&amp; isOpen());</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//如果要求映射的文件大小为0，则不调用操作系统的mmap调用，只是生成一个空间容量为0的DirectByteBuffer</span></div><div class="line">            <span class="comment">//并返回</span></div><div class="line">            <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</div><div class="line">                addr = <span class="number">0</span>;</div><div class="line">                <span class="comment">// a valid file descriptor is not required</span></div><div class="line">                FileDescriptor dummy = <span class="keyword">new</span> FileDescriptor();</div><div class="line">                <span class="keyword">if</span> ((!writable) || (imode == MAP_RO))</div><div class="line">                    <span class="keyword">return</span> Util.newMappedByteBufferR(<span class="number">0</span>, <span class="number">0</span>, dummy, <span class="keyword">null</span>);</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    <span class="keyword">return</span> Util.newMappedByteBuffer(<span class="number">0</span>, <span class="number">0</span>, dummy, <span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//allocationGranularity的大小在我的系统上是4K</span></div><div class="line">            <span class="comment">//页对齐，pagePosition为第多少页</span></div><div class="line">            <span class="keyword">int</span> pagePosition = (<span class="keyword">int</span>)(position % allocationGranularity);</div><div class="line">            <span class="comment">//从页的最开始映射</span></div><div class="line">            <span class="keyword">long</span> mapPosition = position - pagePosition;</div><div class="line">            <span class="comment">//因为从页的最开始映射，增大映射空间</span></div><div class="line">            <span class="keyword">long</span> mapSize = size + pagePosition;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// If no exception was thrown from map0, the address is valid</span></div><div class="line">                <span class="comment">//native方法，源代码在openjdk/jdk/src/solaris/native/sun/nio/ch/FileChannelImpl.c,</span></div><div class="line">                <span class="comment">//参见下面的说明</span></div><div class="line">                addr = map0(imode, mapPosition, mapSize);</div><div class="line">            &#125; <span class="keyword">catch</span> (OutOfMemoryError x) &#123;</div><div class="line">                <span class="comment">// An OutOfMemoryError may indicate that we've exhausted memory</span></div><div class="line">                <span class="comment">// so force gc and re-attempt map</span></div><div class="line">                System.gc();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(<span class="number">100</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException y) &#123;</div><div class="line">                    Thread.currentThread().interrupt();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    addr = map0(imode, mapPosition, mapSize);</div><div class="line">                &#125; <span class="keyword">catch</span> (OutOfMemoryError y) &#123;</div><div class="line">                    <span class="comment">// After a second OOME, fail</span></div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Map failed"</span>, y);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// On Windows, and potentially other platforms, we need an open</span></div><div class="line">            <span class="comment">// file descriptor for some mapping operations.</span></div><div class="line">            FileDescriptor mfd;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mfd = nd.duplicateForMapping(fd);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</div><div class="line">                unmap0(addr, mapSize);</div><div class="line">                <span class="keyword">throw</span> ioe;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">assert</span> (IOStatus.checkAll(addr));</div><div class="line">            <span class="keyword">assert</span> (addr % allocationGranularity == <span class="number">0</span>);</div><div class="line">            <span class="keyword">int</span> isize = (<span class="keyword">int</span>)size;</div><div class="line">            Unmapper um = <span class="keyword">new</span> Unmapper(addr, mapSize, isize, mfd);</div><div class="line">            <span class="keyword">if</span> ((!writable) || (imode == MAP_RO)) &#123;</div><div class="line">                <span class="keyword">return</span> Util.newMappedByteBufferR(isize,</div><div class="line">                                                 addr + pagePosition,</div><div class="line">                                                 mfd,</div><div class="line">                                                 um);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> Util.newMappedByteBuffer(isize,</div><div class="line">                                                addr + pagePosition,</div><div class="line">                                                mfd,</div><div class="line">                                                um);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            threads.remove(ti);</div><div class="line">            end(IOStatus.checkAll(addr));</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><code>map0</code>的源码实现：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function">JNIEXPORT jlong JNICALL</span></div><div class="line"><span class="title">Java_sun_nio_ch_FileChannelImpl_map0</span><span class="params">(JNIEnv *env, jobject <span class="keyword">this</span>,</span></div><div class="line">                                     jint prot, jlong off, jlong len)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">void</span> *mapAddress = <span class="number">0</span>;</div><div class="line">    jobject fdo = (*env)-&gt;GetObjectField(env, <span class="keyword">this</span>, chan_fd);</div><div class="line">    <span class="comment">//linux系统调用是通过整型的文件id引用文件的，这里得到文件id</span></div><div class="line">    jint fd = fdval(env, fdo);</div><div class="line">    <span class="keyword">int</span> protections = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> flags = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (prot == sun_nio_ch_FileChannelImpl_MAP_RO) &#123;</div><div class="line">        protections = PROT_READ;</div><div class="line">        flags = MAP_SHARED;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prot == sun_nio_ch_FileChannelImpl_MAP_RW) &#123;</div><div class="line">        protections = PROT_WRITE | PROT_READ;</div><div class="line">        flags = MAP_SHARED;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prot == sun_nio_ch_FileChannelImpl_MAP_PV) &#123;</div><div class="line">        protections =  PROT_WRITE | PROT_READ;</div><div class="line">        flags = MAP_PRIVATE;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//这里就是操作系统调用了，mmap64是宏定义，实际最后调用的是mmap</span></div><div class="line">    mapAddress = mmap64(</div><div class="line">        <span class="number">0</span>,                    <span class="comment">/* Let OS decide location */</span></div><div class="line">        len,                  <span class="comment">/* Number of bytes to map */</span></div><div class="line">        protections,          <span class="comment">/* File permissions */</span></div><div class="line">        flags,                <span class="comment">/* Changes are shared */</span></div><div class="line">        fd,                   <span class="comment">/* File descriptor of mapped file */</span></div><div class="line">        off);                 <span class="comment">/* Offset into file */</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mapAddress == MAP_FAILED) &#123;</div><div class="line">        <span class="keyword">if</span> (errno == ENOMEM) &#123;</div><div class="line">            <span class="comment">//如果没有映射成功，直接抛出OutOfMemoryError</span></div><div class="line">            JNU_ThrowOutOfMemoryError(env, <span class="string">"Map failed"</span>);</div><div class="line">            <span class="keyword">return</span> IOS_THROWN;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> handle(env, <span class="number">-1</span>, <span class="string">"Map failed"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> ((jlong) (<span class="keyword">unsigned</span> <span class="keyword">long</span>) mapAddress);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>虽然<code>FileChannel.map()</code>的zise参数是long，但是size的大小最大为Integer.MAX_VALUE,也就是最大只能映射最大2G大小的空间。实际上操作系统提供的MMAP可以分配更大的空间，但是JAVA限制在2G，ByteBuffer等Buffer也最大只能分配2G大小的缓冲区。<br>MappedByteBuffer是通过mmap产生得到的缓冲区，这部分缓冲区是由操作系统直接创建和管理的，最后JVM通过unmmap让操作系统直接释放这部分内存。</p>
<h1 id="Haep-Buffer"><a href="#Haep-Buffer" class="headerlink" title="Haep**Buffer"></a>Haep<em>**</em>Buffer</h1><p>下面以ByteBuffer为例，说明Heap类型Buffer的细节。<br>该类型的Buffer可以通过下面方式产生：</p>
<ul>
<li><code>ByteBuffer.allocate(int capacity)</code></li>
<li><code>ByteBuffer.wrap(byte[] array)</code><br>使用传入的数组作为底层缓冲区，变更数组会影响缓冲区，变更缓冲区也会影响数组。</li>
<li><code>ByteBuffer.wrap(byte[] array,int offset, int length)</code><br>使用传入的数组的一部分作为底层缓冲区，变更数组的对应部分会影响缓冲区，变更缓冲区也会影响数组。</li>
</ul>
<h1 id="DirectByteBuffer"><a href="#DirectByteBuffer" class="headerlink" title="DirectByteBuffer"></a>DirectByteBuffer</h1><p>  DirectByteBuffer只能通过<code>ByteBuffer.allocateDirect(int capacity)</code> 产生。<br>  <code>ByteBuffer.allocateDirect()</code>源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title">allocateDirect</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DirectByteBuffer(capacity);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> <code>DirectByteBuffer()</code>源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">DirectByteBuffer(int cap) &#123;                   // package-private</div><div class="line"></div><div class="line">    super(-1, 0, cap, cap);</div><div class="line">    //直接内存是否要页对齐，我本机测试的不用</div><div class="line">    boolean pa = VM.isDirectMemoryPageAligned();</div><div class="line">    //页的大小，本机测试的是4K</div><div class="line">    int ps = Bits.pageSize();</div><div class="line">    //如果页对齐，则size的大小是ps+cap，ps是一页，cap也是从新的一页开始，也就是页对齐了</div><div class="line">    long size = Math.max(1L, (long)cap + (pa ? ps : 0));</div><div class="line">    //JVM维护所有直接内存的大小，如果已分配的直接内存加上本次要分配的大小超过允许分配的直接内存的最大值会</div><div class="line">    //引起GC，否则允许分配并把已分配的直接内存总量加上本次分配的大小。如果GC之后，还是超过所允许的最大值，</div><div class="line">    //则throw new OutOfMemoryError(&quot;Direct buffer memory&quot;);</div><div class="line">    Bits.reserveMemory(size, cap);</div><div class="line"></div><div class="line">    long base = 0;</div><div class="line">    try &#123;</div><div class="line">       //是吧，unsafe可以直接操作底层内存</div><div class="line">        base = unsafe.allocateMemory(size);</div><div class="line">    &#125; catch (OutOfMemoryError x) &#123;、</div><div class="line">        //没有分配成功，把刚刚加上的已分配的直接内存的大小减去。</div><div class="line">        Bits.unreserveMemory(size, cap);</div><div class="line">        throw x;</div><div class="line">    &#125;</div><div class="line">    unsafe.setMemory(base, size, (byte) 0);</div><div class="line">    if (pa &amp;&amp; (base % ps != 0)) &#123;</div><div class="line">        // Round up to page boundary</div><div class="line">        address = base + ps - (base &amp; (ps - 1));</div><div class="line">    &#125; else &#123;</div><div class="line">        address = base;</div><div class="line">    &#125;</div><div class="line">    cleaner = Cleaner.create(this, new Deallocator(base, size, cap));</div><div class="line">    att = null;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>unsafe.allocateMemory()</code>的源码在openjdk/src/openjdk/hotspot/src/share/vm/prims/unsafe.cpp中。具体的源码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">UNSAFE_ENTRY(jlong, Unsafe_AllocateMemory(JNIEnv *env, jobject unsafe, jlong size))</div><div class="line">  UnsafeWrapper(<span class="string">"Unsafe_AllocateMemory"</span>);</div><div class="line">  <span class="keyword">size_t</span> sz = (<span class="keyword">size_t</span>)size;</div><div class="line">  <span class="keyword">if</span> (sz != (julong)size || size &lt; <span class="number">0</span>) &#123;</div><div class="line">    THROW_0(vmSymbols::java_lang_IllegalArgumentException());</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (sz == <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">  &#125;</div><div class="line">  sz = round_to(sz, HeapWordSize);</div><div class="line">  <span class="comment">//最后调用的是 u_char* ptr = (u_char*)::malloc(size + space_before + space_after)，也就是malloc。</span></div><div class="line">  <span class="keyword">void</span>* x = os::<span class="built_in">malloc</span>(sz, mtInternal);</div><div class="line">  <span class="keyword">if</span> (x == <span class="literal">NULL</span>) &#123;</div><div class="line">    THROW_0(vmSymbols::java_lang_OutOfMemoryError());</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//Copy::fill_to_words((HeapWord*)x, sz / HeapWordSize);</span></div><div class="line">  <span class="keyword">return</span> addr_to_java(x);</div><div class="line">UNSAFE_END</div></pre></td></tr></table></figure></p>
<p>JVM通过malloc分配得到连续的缓冲区，这部分缓冲区可以直接作为缓冲区参数进行操作系统调用。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://YDDMAX.github.io/2017/06/05/JDK源码之编译/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yunzhu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YDDMAX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/05/JDK源码之编译/" itemprop="url">
                  JDK源码之编译
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-05T21:19:58+08:00">
                2017-06-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文主要说明如何编译组成rt.jar的源码，不涉及JVM的编译。</p>
<h1 id="rt-jar"><a href="#rt-jar" class="headerlink" title="rt.jar"></a>rt.jar</h1><p>rt.jar也就是运行时相关的class类，安装的jre里面的rt.jar是不能被debug的，为了对JDK的源码进行debug跟踪，需要重新编译rt.jar。<br>rt.jar的全部源码在openjdk的jdk目录下，具体的路径是openjdk\jdk\src\，源码根据操作系统的不同和是否共享分成几个目录。<br><strong>实际上rt.jar因为操作系统的不同，所包含的class也会有所不同，这导致在一些特殊特性上JAVA不再是“一次编译，到处执行”。</strong><br><strong>比如，在java7中，linux/unix下的jre支持<code>com.sun.java.swing.plaf.gtk.GTKLookAndFeel</code></strong>,但是windows就不支持。<br>操作系统安装的JDK里面的src.zip不包含<strong>sun.*包</strong>，<strong><em>sun.\</em></strong>包在openjdk源码里面,具体的路径是：<strong>jdk\src\share\classes</strong>。<br>src.zip除了缺少sun.*包，还缺少其他源代码，不过这些源代码都能在share目录和各操作系统对应目录下找到。<br>openjdk的目录说明和源码下载参见：<a href="https://yddmax.github.io/2017/06/05/openjdk%E6%BA%90%E7%A0%81%E7%9B%AE%E5%BD%95/">openjdk目录</a></p>
<h1 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h1><p>本文编译的是openjdk-7里面jdk目录下的源码。</p>
<ol>
<li>新建java project</li>
<li>将openjdk源码copy到project中。除了复制share目录下的共享源码，还需要复制具体操作系统下的源码。</li>
<li>编译导出jar。</li>
</ol>
<p>参考资料：<a href="http://bijian1013.iteye.com/blog/2302520" target="_blank" rel="external">怎么对jdk核心包进行跟踪调试，并查看调试中的变量值</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://YDDMAX.github.io/2017/06/05/openjdk源码目录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yunzhu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YDDMAX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/05/openjdk源码目录/" itemprop="url">
                  openjdk源码目录
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-05T20:53:40+08:00">
                2017-06-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文主要参考自：<a href="http://blog.csdn.net/socrj/article/details/43916221" target="_blank" rel="external">openjdk源码结构</a></p>
<h1 id="源码下载"><a href="#源码下载" class="headerlink" title="源码下载"></a>源码下载</h1><p>openjdk-7的源码：<a href="http://pan.baidu.com/s/1qYAtBK4" target="_blank" rel="external">openjdk7源码</a><br>openjdk-8的源码：<a href="http://download.csdn.net/download/socrj/8454221" target="_blank" rel="external">openJDK8源码</a></p>
<h1 id="目录说明"><a href="#目录说明" class="headerlink" title="目录说明"></a>目录说明</h1><p>openjdk的源码的目录结构如下图所示：<br><img src="http://oqxil93b6.bkt.clouddn.com/images/openjdk%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84openjdk-source-structure.png" alt="此处输入图片的描述"></p>
<p>各个目录的说明如下：<br><strong>—— corba：不流行的多语言、分布式通讯接口<br>—— hotspot：Java 虚拟机<br>—— jaxp：XML 处理<br>—— jaxws：一组 XML web services 的 Java API<br>—— jdk：java 开发工具包<br>—— —— 针对操作系统的部分<br>—— —— share：与平台无关的实现<br>—— langtools：Java 语言工具<br>—— nashorn：JVM 上的 JavaScript 运行时</strong></p>
<p>为了让大家易于理解，有所简化了结构。</p>
<h2 id="Corba"><a href="#Corba" class="headerlink" title="Corba"></a>Corba</h2><p>全称 Common Object Request Broker Architecture，通用对象请求代理架构，是基于 对象-服务 机制设计得。</p>
<p>与 JavaBean、COM 等是同种范畴。</p>
<p>目前，通用的远程过程调用协议是 SOAP（Simple Object Access Protocol，简单对象访问协议），消息格式是 XML-RPC（存在 Json-RPC）。<br>另外，Apache Thrift 提供了多语言 C/S 通讯支持； 不少语言也内置了跨语言调用或对分布式环境友好，比如： lua 可以与 c 代码互调用，Go 可以调用 C 代码，erlang 在本地操作与分布式环境下的操作方法一样等。<br><strong>Corba和RMI类似，都能实现RPC。但是RMI只是针对JAVA环境的，Corba是支持多语言的方案</strong></p>
<h2 id="Hotspot"><a href="#Hotspot" class="headerlink" title="Hotspot"></a>Hotspot</h2><p>全称 Java HotSpot Performance Engine，是 Java 虚拟机的一个实现，包含了服务器版和桌面应用程序版。利用 JIT 及自适应优化技术（自动查找性能热点并进行动态优化）来提高性能。</p>
<p>使用 java -version 可以查看 Hotspot 的版本。</p>
<p>从 Java 1.3 起为默认虚拟机，现由 Oracle 维护并发布。</p>
<p>其他 java 虚拟机：</p>
<ul>
<li>JRockit：专注于服务器端，曾经号称是“世界上速度最快的 Java 虚拟机”，现归于 Oracle 旗下。</li>
<li>J9：IBM 设计的 Java 虚拟机。</li>
<li>Harmony：Apache 的顶级项目之一，从 2011 年 11 月 6 日起入驻 Apache 的 Java 项目。虽然其能够兼容 jdk，但由于 JCP （Java Community Process）仅仅允许授权给 Harmony 一个带有限制条件的TCK（Technology Compatibility Kit），即仅仅能使用在 J2SE ,而不是所有Java实现上（包括 J2ME 和 J2EE），导致了 Apache 组织与 Oracle 的决裂。Harmony 是 Android 虚拟机 Dalvik 的前身。</li>
<li>Dalvik 并不是 Java 虚拟机，它执行的是 dex 文件而不是 class 文件，使用的也是寄存器架构而不是栈架构 。</li>
</ul>
<h2 id="jaxp"><a href="#jaxp" class="headerlink" title="jaxp"></a>jaxp</h2><p>全称 Java API for XML Processing，处理 XML 的Java API，是 Java XML 程序设计的应用程序接口之一，它提供解析和验证XML文档的能力。<br>jaxp 提供了处理 xml 文件的三种接口：</p>
<ul>
<li>DOM 接口（文档对象模型解析），位于 \openjdk\jaxp\src\org\w3c\dom</li>
<li>SAX 接口（xml 简单 api 解析），位于 \openjdk\jaxp\src\org\xml\sax</li>
<li>StAX 接口（xml 流 api），位于 \openjdk\jaxp\src\javax\xml</li>
<li>除了解析接口，JAXP还提供了XSLT接口用来对XML文档进行数据和结构的转换。</li>
</ul>
<h2 id="JaxWS"><a href="#JaxWS" class="headerlink" title="JaxWS"></a>JaxWS</h2><p>全称 Java API for Web Services，JAX-WS 允许开发者选择 RPC-oriented（面向 RPC） 或者 message-oriented（消息通信，erlang 使用的就是消息通信，不过 Java 内存模型是内存共享）来实现自己的web services。</p>
<p>通过 Web Services 提供的环境，可以实现 Java 与其他编程语言的交互（事实上就是 thrift 所做的，任何一种语言都可以通过 Web Services 实现与其他语言的通信，客户端用一种语言，服务器端可以用其他语言）。</p>
<h2 id="LangTools"><a href="#LangTools" class="headerlink" title="LangTools"></a>LangTools</h2><p>Java 语言支持工具</p>
<h2 id="JDK"><a href="#JDK" class="headerlink" title="JDK"></a>JDK</h2><p>全称 Java Development Kit。</p>
<p><strong>share</strong></p>
<p><strong>classes</strong> 目录里的是 Java 的实现，<strong>native</strong> 目录里的是 C++ 的实现，两部分基本对应。这两个目录里的结构与 java 的包也是对应，各个部分的用途另外再讲。</p>
<p>back、instrument、javavm、npt、transport 几个部分是实现 java 的基础部分，都是 C++ 代码，在这里从最底层理解 java，往后这些内容也会详讲。</p>
<p>sample 和 demo 目录有以下示例，区别在于 demo 目录是 针对 applets 的。</p>
<h2 id="Nashorn"><a href="#Nashorn" class="headerlink" title="Nashorn"></a>Nashorn</h2><p>Nashorn 项目的目的是基于 Java 在 JVM 上实现一个轻量级高性能的 JavaScript 运行环境。基于 JSR-223 协议，Java 程序员可在 Java 程序中嵌入 JavaScript 代码。<br>该项目使用了 JSR-229 里描述的新连接机制（从 Java7起开始使用的连接机制）：新的字节码（invokedynamic）以及新的基于方法句柄（method handle）的连接机制。通过接口注入（interface injection）在运行时修改类也是 JSR-229 里的内容。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://YDDMAX.github.io/2017/06/04/JAVA-IO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yunzhu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YDDMAX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/04/JAVA-IO/" itemprop="url">
                  JAVA IO
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-04T14:14:39+08:00">
                2017-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/technology/" itemprop="url" rel="index">
                    <span itemprop="name">technology</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="计算机IO"><a href="#计算机IO" class="headerlink" title="计算机IO"></a>计算机IO</h1><p>本部分内容主要参考自《JAVA NIO》的第一章简介。</p>
<h2 id="缓冲区操作"><a href="#缓冲区操作" class="headerlink" title="缓冲区操作"></a>缓冲区操作</h2><p>下图简单描述了数据从外部磁盘向运行中的进程的内存区域移动的过程。<br>进程使用 read( )系统调用，要求其缓冲区被填满。内核随即向磁盘控制硬件发出命令，要求其从磁盘读取数据。磁盘控制器把数据直接写入内核内存缓冲区，<strong>这一步通过 DMA 完成，无需主 CPU 协助</strong>。一旦磁盘控制器把缓冲区装满，内核即把数据从内核空间的临时缓冲区拷贝到进程执行 read()调用时指定的缓冲区。<br>  <img src="http://oqxil93b6.bkt.clouddn.com/images/JAVA%20IO/buffer-io.png" alt="缓冲区操作"><br>为什么不让磁盘控制器直接将磁盘上数据直接copy到用户缓冲区呢？</p>
<ul>
<li>硬件无法直接访问用户空间</li>
<li><p>像磁盘这样基于块存储的硬件设备操作的是固定大小的数据块，而用户进程请求的可能是任意大小的或非对齐的数据块。在数据往来于用户空间与存储设备的过程中，内核负责<br>数据的分解、再组合工作，因此充当着中间人的角色。 </p>
<h2 id="发散和汇聚"><a href="#发散和汇聚" class="headerlink" title="发散和汇聚"></a>发散和汇聚</h2><p>根据发散／汇聚的概念，进程只需一个系统调用，就能把一连串缓冲区地址传递给操作系统。然后，内核就可以顺序填充或排干多个缓冲区，读的时候就把数据发散到多个用户空间缓冲区，写的时候再从多个缓冲区把数据汇聚起来（如下图所示）。<br><img src="http://oqxil93b6.bkt.clouddn.com/images/JAVA%20IO/scatter-gather.png" alt="发散和汇聚"><br>优点：</p>
</li>
<li><p>这样用户进程就不必多次执行系统调用（那样做可能代价不菲）</p>
</li>
<li>内核也可以优化数据的处理过程，因为它已掌握待传输数据的全部信息。</li>
<li>如果系统配有多个 CPU，甚至可以同时填充或排干多个缓冲区。</li>
<li><p>多个缓冲区可能方便一些特定协议的编程（自己加的）。</p>
<h2 id="虚拟内存"><a href="#虚拟内存" class="headerlink" title="虚拟内存"></a>虚拟内存</h2><p>现代操作系统都支持虚拟内存，CPU为了更好的支持虚拟内存也加入了MMU（内存管理单元）。在寻址时，需要把虚拟地址经过MMU计算得到真实的物理地址，然后再去寻址。<br>虚拟内存的好处：</p>
</li>
<li><p>一个以上的虚拟地址可指向同一个物理内存地址。</p>
</li>
<li><p>虚拟内存空间可大于实际可用的硬件内存。</p>
<h2 id="内存页面调度"><a href="#内存页面调度" class="headerlink" title="内存页面调度"></a>内存页面调度</h2><p><strong>为了支持虚拟内存，需要把内存存储到硬盘上，现代操作系统是通过内存页面调度实现的。对于采用分页技术的现代操作系统而言，这也是数据在磁盘与物理内存之间往来的唯一方式。</strong><br>下面的步骤说明了内存页面调度的过程：</p>
</li>
<li><p>当 CPU 引用某内存地址时，MMU负责确定该地址所在页（往往通过对地址值进行移位或屏蔽位操作实现），并将虚拟页号转换为物理页号（这一步由硬件完成，速度极快）。如果当前不存在与该虚拟页形成有效映射的物理内存页，MMU 会向 CPU 提交一个页错误。</p>
</li>
<li>页错误随即产生一个陷阱（类似于系统调用），把控制权移交给内核，附带导致错误的虚拟地址信息，然后内核采取步骤验证页的有效性。内核会安排页面调入操作，把缺失的页内容读回物理内存。这往往导致别的页被移出物理内存，好给新来的页让地方。在这种情况下，如果待移出的页已经被碰过了（自创建或上次页面调入以来，内容已发生改变），还必须首先执行页面调出，把页内容拷贝到磁盘上的分页区。</li>
<li><p>如果所要求的地址不是有效的虚拟内存地址（不属于正在执行的进程的任何一个内存段），则该页不能通过验证，段错误随即产生。于是，控制权转交给内核的另一部分，通常导致的结果就是进程被强令关闭。<br>一旦出错的页通过了验证，MMU 随即更新，建立新的虚拟到物理的映射（如有必要，中断被移出页的映射），用户进程得以继续。造成页错误的用户进程对此不会有丝毫察觉，一切都在不知不觉中进行。</p>
<h2 id="文件IO"><a href="#文件IO" class="headerlink" title="文件IO"></a>文件IO</h2><p><strong>虚拟内存通过页面调度可以调度内存页和硬盘页，现代操作系统对文件IO的操作也是基于页面调度实现的。</strong><br>采用分页技术的操作系统执行 I/O 的全过程可总结为以下几步：</p>
</li>
<li><p>确定请求的数据分布在文件系统的哪些页（磁盘扇区组）。磁盘上的文件内容和元数<br>据可能跨越多个文件系统页，而且这些页可能也不连续。</p>
</li>
<li>在内核空间分配足够数量的内存页，以容纳得到确定的文件系统页。</li>
<li>在内存页与磁盘上的文件系统页之间建立映射。</li>
<li>为每一个内存页产生页错误。</li>
<li>虚拟内存系统俘获页错误，安排页面调入，从磁盘上读取页内容，使页有效。</li>
<li><p>一旦页面调入操作完成，文件系统即对原始数据进行解析，取得所需文件内容或属性信息。</p>
<h3 id="内存映射文件"><a href="#内存映射文件" class="headerlink" title="内存映射文件"></a>内存映射文件</h3><p><strong>为了在内核空间的文件系统页与用户空间的内存区之间移动数据，<code>一次以上的拷贝操作几乎总是免不了的</code>。这是因为，在文件系统页与用户缓冲区之间往往没有一一对应关系。</strong>但是，还有一种大多数操作系统都支持的特殊类型的 I/O 操作，允许用户进程最大限度地利用面向页的系统 I/O 特性，并完全摒弃缓冲区拷贝。这就是内存映射 I/O。<br><strong>内存映射文件将内存页全部映射到文件的硬盘块上，存在一一映射关系。使用内存映射文件时，用户态是没有缓冲区的，只存在映射到硬盘页的内存页面缓冲区，所以是真正的ZeroCopy。而不使用内存映射文件的IO，因为直接内存和内存页缓冲区没有映射关系，所以使使用直接内存作为缓冲区也是需要最少一次copy的。</strong><code>（那文件IO时使用直接内存的好处是什么？）</code></p>
<h3 id="文件锁定"><a href="#文件锁定" class="headerlink" title="文件锁定"></a>文件锁定</h3><p>JVM实现的是进程之间的锁定，一个进程之间的多个线程之间是不锁定的。<br>支持共享锁、独占锁等<br>支持锁定文件的部分区域，粒度支持到字节。</p>
<h3 id="流IO"><a href="#流IO" class="headerlink" title="流IO"></a>流IO</h3><p>流的传输一般（也不必然如此）比块设备慢，经常用于间歇性输入。多数操作系统允许把流置于非块模式，这样，进程可以查看流上是否有输入，即便当时没有也不影响它干别的。这样一种能力使得进程可以在有输入的时候进行处理，输入流闲置的时候执行其他功能。<br>处理流IO需要依赖操作系统的通知机制：</p>
</li>
<li><p>Selector通知已就绪，可以进行相关IO操作。</p>
</li>
<li>AIO通知IO操作已完成，可以处理相关业务逻辑了。</li>
</ul>
<h1 id="JAVA-IO-发展和总结"><a href="#JAVA-IO-发展和总结" class="headerlink" title="JAVA IO 发展和总结"></a>JAVA IO 发展和总结</h1><p>BIO 抽象工作良好，适应用途广泛。但是当<strong>移动大量数据</strong>时，这些 I/O 类可伸缩性不强，也没有提供当今大多数操作系统普遍具备的常用 I/O 功能，如<strong>文件锁定</strong>、<strong>非块 I/O</strong>、<strong>就绪性选择</strong>和<strong>内存映射</strong>。这些特性对实现可伸缩性是至关重要的，对保持与非 Java 应用程序的正常交互也可以说是必不可少的，尤其是在企业应用层面，而传统的 Java I/O 机制却没有模拟这些通用 I/O 服务。操作系统与 Java 基于流的 I/O模型有些不匹配。操作系统要移动的是大块数据（缓冲区），这往往是在硬件直接存储器存取（DMA）的协助下完成的。<strong>BIO 类喜欢操作小块数据——单个字节、几行文本。</strong></p>
<ul>
<li>BIO<br>JDK版本：1.1<br>时间：<br>特点：</li>
</ul>
<ol>
<li>同步阻塞</li>
<li>面向流（字节流和字符流）</li>
<li>不支持操作系统支持的很多IO概念和特性</li>
<li>read()操作返回所读的字节数，write操作没有返回值</li>
<li>read是SeekAble的（支持skip），write不是Seekable的。</li>
</ol>
<ul>
<li>NIO.1<br>JDK版本：1.4<br>时间：2002<br>特点：</li>
</ul>
<ol>
<li>针对现代操作系统重新抽象和封装实现了Channel和Buffer</li>
<li>网络IO支持配置是否阻塞，文件IO只能是阻塞的</li>
<li>网络IO支持多路复用（异步），使用多路复用时，Channel必须是非阻塞模式，而且阻塞模式不能再被修改</li>
<li>网络IO和文件IO都是可中断的。文件IO过程中被中断时，JVM会关闭Channel。</li>
<li>支持直接Buffer、支持内存映射文件</li>
<li>支持文件锁定，但是是进程级别的锁定</li>
<li>支持Pipe</li>
<li>read操作返回所读的字节数，write操作返回所写的字节数</li>
<li>Channel是全双工的。虽然RandomAccessFile也可以是全双工的，但是Channel这种封装方式更好</li>
</ol>
<ul>
<li>NIO.2（AIO）<br>JDK版本：1.7<br>时间：2011<br>特点：</li>
</ul>
<ol>
<li>文件IO和网络IO是异步的（当然是非阻塞的），异步形式是future和callback。</li>
<li>Watch Service</li>
<li>文件IO支持更丰富的API</li>
</ol>
<h1 id="BIO"><a href="#BIO" class="headerlink" title="BIO"></a>BIO</h1><h1 id="NIO-1"><a href="#NIO-1" class="headerlink" title="NIO.1"></a>NIO.1</h1><h1 id="NIO-2"><a href="#NIO-2" class="headerlink" title="NIO.2"></a>NIO.2</h1><h2 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h2><h3 id="Watch-Service"><a href="#Watch-Service" class="headerlink" title="Watch Service"></a>Watch Service</h3><h3 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h3><h2 id="更丰富的文件操作"><a href="#更丰富的文件操作" class="headerlink" title="更丰富的文件操作"></a>更丰富的文件操作</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://YDDMAX.github.io/2017/06/04/Pro-Java-7-NIO-2读书笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yunzhu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YDDMAX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/04/Pro-Java-7-NIO-2读书笔记/" itemprop="url">
                  Pro Java 7 NIO 2读书笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-04T11:44:38+08:00">
                2017-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/technology/" itemprop="url" rel="index">
                    <span itemprop="name">technology</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://www.tuicool.com/articles/IRfIJ3" target="_blank" rel="external">转自</a><br> <img src="http://oqxil93b6.bkt.clouddn.com/images/Pro%20Java%207%20NIO%202%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/pro-java7-nio.png" alt="Pro Java 7 NIO.2"><br>花了几天把这本书初略的看了一下， 之所以初略的看了一下，是因为这书里确实没啥内容。如果去了NIO 1的内容和大段大段的代码， 基本上压缩到50页应该没问题。 </p>
<p>下面简单的罗列一下看到的内容： </p>
<h1 id="Path"><a href="#Path" class="headerlink" title="Path"></a>Path</h1><p>这个类在java.nio.file，在NIO里对文件系统进行了进一步的抽象。 是用来替换原来的java.io.File。其中 FileSystems, Files, Path, PathMatcher 成为一个体系。 </p>
<p>在java7里File和Path可以相互转换： File.toPath(), Path.toFile()<br>原来的File里包含了文件引用和文件，在Path系统里， Path里是文件的引用，而文件操作都放到了Files的静态方法里。这种方式究竟好不好用，我没啥感觉。不过我个人偏向于把操作放到另外一个类里面。 </p>
<p>获得Path实例的方式：<br><code>File.toPath(), Paths.get(), FileSystem.getPath()</code></p>
<p>注意： Path和File一样，能创建出实例不代表着这个文件一定在文件系统里真是存在。 </p>
<p>Path和File相比使用上方便了的地方： </p>
<p><strong>不用特意指定路径的separator：</strong><br><code>Paths.get(&quot;C:&quot;,&quot;folder1&quot;,&quot;subfolder&quot;,&quot;aa.txt&quot;)</code></p>
<p>在windows系统了是C:\folder1\subfolder\aa.txt<br>在Mac下是C:/folder/subfolder/aa.txt<br>Java会根据当前操作系统来决定separator </p>
<p><strong>重复利用基本路径：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//define the fixed path</span></div><div class="line">Path base = Paths.get(<span class="string">"C:/rafaelnadal/tournaments/2009"</span>);</div><div class="line"><span class="comment">//resolve BNP.txt file</span></div><div class="line">Path path_1 = base.resolve(<span class="string">"BNP.txt"</span>);</div><div class="line"><span class="comment">//output: C:\rafaelnadal\tournaments\2009\BNP.txt</span></div><div class="line">System.out.println(path_1.toString());</div><div class="line"><span class="comment">//resolve AEGON.txt file</span></div><div class="line">Path path_2 = base.resolve(<span class="string">"AEGON.txt"</span>);</div><div class="line"><span class="comment">//output: C:\rafaelnadal\tournaments\2009\AEGON.txt</span></div><div class="line">System.out.println(path_2.toString());</div></pre></td></tr></table></figure></p>
<p><strong>而resolveSibling方法更加好用：可以直接获取相同目录下的其他文件：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//define the fixed path</span></div><div class="line">Path base = Paths.get(<span class="string">"C:/rafaelnadal/tournaments/2009/BNP.txt"</span>);</div><div class="line"><span class="comment">//resolve sibling AEGON.txt file</span></div><div class="line">Path path = base.resolveSibling(<span class="string">"AEGON.txt"</span>);</div><div class="line"><span class="comment">//output: C:\rafaelnadal\tournaments\2009\AEGON.txt</span></div><div class="line">System.out.println(path.toString());</div></pre></td></tr></table></figure></p>
<p><strong>取得相对路径：</strong><br>假设BNP.txt和AEGON.txt在同一目录下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Path path01 = Paths.get(<span class="string">"BNP.txt"</span>);</div><div class="line">Path path02 = Paths.get(<span class="string">"AEGON.txt"</span>);</div><div class="line"></div><div class="line"><span class="comment">//output: ..\AEGON.txt</span></div><div class="line">Path path01_to_path02 = path01.relativize(path02);</div><div class="line">System.out.println(path01_to_path02);</div><div class="line"><span class="comment">//output: ..\BNP.txt</span></div><div class="line">Path path02_to_path01 = path02.relativize(path01);</div><div class="line">System.out.println(path02_to_path01);</div></pre></td></tr></table></figure></p>
<p>假设：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Path path01 = Paths.get(<span class="string">"/tournaments/2009/BNP.txt"</span>);</div><div class="line">Path path02 = Paths.get(<span class="string">"/tournaments/2011"</span>);</div></pre></td></tr></table></figure></p>
<p>那么：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//output: ..\..\2011</span></div><div class="line">Path path01_to_path02 = path01.relativize(path02);</div><div class="line">System.out.println(path01_to_path02);</div><div class="line"><span class="comment">//output: ..\2009\BNP.txt</span></div><div class="line">Path path02_to_path01 = path02.relativize(path01);</div><div class="line">System.out.println(path02_to_path01);</div></pre></td></tr></table></figure></p>
<p><strong>遍历：</strong><br>Path实现了Iterable<path></path>接口，也就是说我们可以这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Path path = Paths.get(<span class="string">"C:"</span>, <span class="string">"rafaelnadal/tournaments/2009"</span>, <span class="string">"BNP.txt"</span>);</div><div class="line"><span class="keyword">for</span> (Path name : path) &#123;</div><div class="line">    System.out.println(name);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>猜猜结果是什么？<br>我一开始以为是吧目录下的文件遍历出来呢。结果是这样的：<br>rafaelnadal<br>tournaments<br>2009<br>BNP.txt<br>说实话，我觉得这个比较坑爹！ </p>
<h1 id="文件属性"><a href="#文件属性" class="headerlink" title="文件属性"></a>文件属性</h1><p>java.nio.file.attribute包下的类提供了获取文件属性的类，针对不同操作系统使用的类不太一样，当然也有所有操作系统通用的属性。 </p>
<p>属性分类有一些几种：<br>BasicFileAttributeView<br>DosFileAttributeView<br>PosixFileAttributeView<br>FileOwnerAttributeView<br>AclFileAttributeView<br>UserDefinedFileAttributeView</p>
<p><strong>获取属性：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">BasicFileAttributes attr = <span class="keyword">null</span>;</div><div class="line">Path path = Paths.get(<span class="string">"C:/rafaelnadal/tournaments/2009"</span>, <span class="string">"BNP.txt"</span>);</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    attr = Files.readAttributes(path, BasicFileAttributes.class);</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    System.err.println(e);</div><div class="line">&#125;</div><div class="line">System.out.println(<span class="string">"File size: "</span> + attr.size());</div><div class="line">System.out.println(<span class="string">"File creation time: "</span> + attr.creationTime());</div><div class="line">System.out.println(<span class="string">"File was last accessed at: "</span> + attr.lastAccessTime());</div><div class="line">System.out.println(<span class="string">"File was last modified at: "</span> + attr.lastModifiedTime());</div><div class="line">System.out.println(<span class="string">"Is directory? "</span> + attr.isDirectory());</div><div class="line">System.out.println(<span class="string">"Is regular file? "</span> + attr.isRegularFile());</div><div class="line">System.out.println(<span class="string">"Is symbolic link? "</span> + attr.isSymbolicLink());</div><div class="line">System.out.println(<span class="string">"Is other? "</span> + attr.isOther());</div></pre></td></tr></table></figure></p>
<p>或 </p>
<p><code>long size = (Long)Files.getAttribute(path, &quot;basic:size&quot;, NOFOLLOW_LINKS);</code></p>
<p><strong>设置属性：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Path path = Paths.get(<span class="string">"C:/rafaelnadal/tournaments/2009"</span>, <span class="string">"BNP.txt"</span>);</div><div class="line"><span class="keyword">long</span> time = System.currentTimeMillis();</div><div class="line">FileTime fileTime = FileTime.fromMillis(time);</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    Files.getFileAttributeView(path,</div><div class="line">        BasicFileAttributeView.class).setTimes(fileTime, fileTime, fileTime);</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    System.err.println(e);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">long</span> time = System.currentTimeMillis();</div><div class="line">FileTime fileTime = FileTime.fromMillis(time);</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    Files.setLastModifiedTime(path, fileTime);</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    System.err.println(e);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>Symbolic和Hard Links</strong><br>相同于用Java程序实现linux下的 ln命令。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Path link = FileSystems.getDefault().getPath(<span class="string">"rafael.nadal.1"</span>);</div><div class="line">Path target= FileSystems.getDefault().getPath(<span class="string">"C:/rafaelnadal/photos"</span>, <span class="string">"rafa_winner.jpg"</span>);</div><div class="line">Files.createSymbolicLink(link, target);</div></pre></td></tr></table></figure></p>
<h1 id="DirectoryStream"><a href="#DirectoryStream" class="headerlink" title="DirectoryStream"></a>DirectoryStream</h1><p>这也是一个比较有用的类：用来遍历路径下的子路径或文件，而且支持通配符过滤。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Path path = Paths.get(<span class="string">"C:/rafaelnadal/tournaments/2009"</span>);</div><div class="line">…</div><div class="line"><span class="comment">//glob pattern applied</span></div><div class="line">System.out.println(<span class="string">"\nGlob pattern applied:"</span>);</div><div class="line"><span class="keyword">try</span> (DirectoryStream&lt;Path&gt; ds = Files.newDirectoryStream(path, <span class="string">"*.&#123;png,jpg,bmp&#125;"</span>)) &#123;</div><div class="line">    <span class="keyword">for</span> (Path file : ds) &#123;</div><div class="line">        System.out.println(file.getFileName());</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    System.err.println(e);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="FileVisitor和Files-walkFileTree"><a href="#FileVisitor和Files-walkFileTree" class="headerlink" title="FileVisitor和Files.walkFileTree"></a>FileVisitor和Files.walkFileTree</h1><p>FileVisitor是一个接口，Files.walkFileTree是一个方法。 通过两者的配合可以遍历整个某个路径下的所有子路径和文件。没有这个之前我们用递归方法也能实现，有了这个不能说是现实更加容易， 只能说是现实更加规范， 如果大家都用这个，代码的可维护性会更好。我觉得仅此而已。 </p>
<p>FileVisitor有四个方法 </p>
<ul>
<li><code>FileVisitResult postVisitDirectory(T dir, IOException exc)</code><br>Invoked for a directory after entries in the directory, and all of their descendants, have been visited.  </li>
<li><code>FileVisitResult preVisitDirectory(T dir, BasicFileAttributes attrs)</code><br>  Invoked for a directory before entries in the directory are visited.<br>+<code>FileVisitResult visitFile(T file, BasicFileAttributes attrs)</code><br>  Invoked for a file in a directory.</li>
<li><code>FileVisitResult visitFileFailed(T file, IOException exc)</code><br>  Invoked for a file that could not be visited.</li>
</ul>
<p>FileVisitResult枚举类型：<br>CONTINUE，SKIP_SIBLINGS，SKIP_SUBTREE，TERMINATE</p>
<h1 id="Watch-Service-API"><a href="#Watch-Service-API" class="headerlink" title="Watch Service API"></a>Watch Service API</h1><p>这是NIO2里比较重要的一个新增功能， 以前直接用java监视文件系统的变化是不可能的，只能通过jni的方式调用操作系统的api来对文件系统进行监视。在java7里这部分被加到了标准库里，这样我们就不能在去寻找jni的结果方案了。但是事实上为了保持java的扩平台特性，<strong><em>监控的功能范围被定为各个操作系统的交集，所以没有特殊的情况还是需要直接调用操作系统的api来实现</em></strong>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">watchRNDir</span><span class="params">(Path path)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">    <span class="keyword">try</span> (WatchService watchService = FileSystems.getDefault().newWatchService()) &#123;</div><div class="line">        path.register(watchService, StandardWatchEventKinds.ENTRY_CREATE,</div><div class="line">        StandardWatchEventKinds.ENTRY_MODIFY, StandardWatchEventKinds.ENTRY_DELETE);</div><div class="line"></div><div class="line">        <span class="comment">//start an infinite loop</span></div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="comment">//retrieve and remove the next watch key</span></div><div class="line">            <span class="keyword">final</span> WatchKey key = watchService.take();</div><div class="line">            <span class="comment">//get list of pending events for the watch key</span></div><div class="line">            <span class="keyword">for</span> (WatchEvent&lt;?&gt; watchEvent : key.pollEvents()) &#123;</div><div class="line">                <span class="comment">//get the kind of event (create, modify, delete)</span></div><div class="line">                <span class="keyword">final</span> Kind&lt;?&gt; kind = watchEvent.kind();</div><div class="line">                <span class="comment">//handle OVERFLOW event</span></div><div class="line">                <span class="keyword">if</span> (kind == StandardWatchEventKinds.OVERFLOW) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//get the filename for the event</span></div><div class="line">                <span class="keyword">final</span> WatchEvent&lt;Path&gt; watchEventPath = (WatchEvent&lt;Path&gt;) watchEvent;</div><div class="line">                <span class="keyword">final</span> Path filename = watchEventPath.context();</div><div class="line">                <span class="comment">//print it out</span></div><div class="line">                System.out.println(kind + <span class="string">" -&gt; "</span> + filename);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//reset the key</span></div><div class="line">            <span class="keyword">boolean</span> valid = key.reset();</div><div class="line">            <span class="comment">//exit loop if the key is not valid (if the directory was deleted, for example)</span></div><div class="line">            <span class="keyword">if</span> (!valid) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Random-Access-Files"><a href="#Random-Access-Files" class="headerlink" title="Random Access Files"></a>Random Access Files</h1><p>主要是提供了一个SeekableByteChannel接口，配合ByteBuffer使随机访问文件更加方便。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">Path path = Paths.get(<span class="string">"C:/rafaelnadal/tournaments/2009"</span>, <span class="string">"MovistarOpen.txt"</span>);</div><div class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1</span>);</div><div class="line">String encoding = System.getProperty(<span class="string">"file.encoding"</span>);</div><div class="line"><span class="keyword">try</span> (SeekableByteChannel seekableByteChannel = (Files.newByteChannel(path, EnumSet.of(StandardOpenOption.READ)))) &#123;</div><div class="line">    <span class="comment">//the initial position should be 0 anyway</span></div><div class="line">    seekableByteChannel.position(<span class="number">0</span>);</div><div class="line">    System.out.println(<span class="string">"Reading one character from position: "</span> + seekableByteChannel.position());</div><div class="line">    seekableByteChannel.read(buffer);</div><div class="line">    buffer.flip();</div><div class="line">    System.out.print(Charset.forName(encoding).decode(buffer));</div><div class="line">    buffer.rewind();</div><div class="line">    <span class="comment">//get into the middle</span></div><div class="line">    seekableByteChannel.position(seekableByteChannel.size()/<span class="number">2</span>);</div><div class="line">    System.out.println(<span class="string">"\nReading one character from position: "</span> + seekableByteChannel.position());</div><div class="line">    seekableByteChannel.read(buffer);</div><div class="line">    buffer.flip();</div><div class="line">    System.out.print(Charset.forName(encoding).decode(buffer));</div><div class="line">    buffer.rewind();</div><div class="line">    <span class="comment">//get to the end</span></div><div class="line">    seekableByteChannel.position(seekableByteChannel.size()-<span class="number">1</span>);</div><div class="line">    System.out.println(<span class="string">"\nReading one character from position: "</span> + seekableByteChannel.position());</div><div class="line">    seekableByteChannel.read(buffer);</div><div class="line">    buffer.flip();</div><div class="line">    System.out.print(Charset.forName(encoding).decode(buffer));</div><div class="line">    buffer.clear();</div><div class="line">&#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">    System.err.println(ex);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Asynchronous-Channel-API"><a href="#Asynchronous-Channel-API" class="headerlink" title="Asynchronous Channel API"></a>Asynchronous Channel API</h1><p>这个是NIO2的较大的变化，有原来的Selecor方法变成方法回调模式。使用上更加方便。并且文件的读写也可以异步的方式实现了。 </p>
<p><strong>异步读取文件 ：</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">100</span>);</div><div class="line">Path path = Paths.get(<span class="string">"C:/rafaelnadal/grandslam/RolandGarros"</span>, <span class="string">"story.txt"</span>);</div><div class="line"><span class="keyword">try</span> (AsynchronousFileChannel asynchronousFileChannel = AsynchronousFileChannel.open(path, StandardOpenOption.READ)) &#123;</div><div class="line">    current = Thread.currentThread();</div><div class="line">    asynchronousFileChannel.read(buffer, <span class="number">0</span>, <span class="string">"Read operation status ..."</span>, <span class="keyword">new</span> CompletionHandler&lt;Integer, Object&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Integer result, Object attachment)</span> </span>&#123;</div><div class="line">            System.out.println(attachment);</div><div class="line">            System.out.print(<span class="string">"Read bytes: "</span> + result);</div><div class="line">            current.interrupt();</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, Object attachment)</span> </span>&#123;</div><div class="line">            System.out.println(attachment);</div><div class="line">            System.out.println(<span class="string">"Error:"</span> + exc);</div><div class="line">            current.interrupt();</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    System.out.println(<span class="string">"\nWaiting for reading operation to end ...\n"</span>);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        current.join();</div><div class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//now the buffer contains the read bytes</span></div><div class="line">    System.out.println(<span class="string">"\n\nClose everything and leave! Bye, bye ..."</span>);</div><div class="line">&#125; <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">    System.err.println(ex);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>异步socket服务器</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncEchoServer</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> AsynchronousServerSocketChannel serverChannel;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        System.out.println(String.format(<span class="string">"start: name: %s"</span>, Thread.currentThread().getName()));</div><div class="line">        serverChannel = AsynchronousServerSocketChannel.open();</div><div class="line">        serverChannel.setOption(StandardSocketOptions.SO_REUSEADDR, <span class="keyword">true</span>);</div><div class="line">        serverChannel.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">8000</span>));</div><div class="line">        serverChannel.accept(serverChannel, <span class="keyword">new</span> Acceptor());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Acceptor</span> <span class="keyword">implements</span> <span class="title">CompletionHandler</span>&lt;<span class="title">AsynchronousSocketChannel</span>, <span class="title">AsynchronousServerSocketChannel</span>&gt; </span>&#123;</div><div class="line">        </div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Acceptor</span><span class="params">()</span></span>&#123;</div><div class="line">            System.out.println(<span class="string">"an acceptor has created."</span>);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(<span class="keyword">final</span> AsynchronousSocketChannel channel, AsynchronousServerSocketChannel serverChannel)</span> </span>&#123;</div><div class="line">            System.out.println(String.format(<span class="string">"write: name: %s"</span>, Thread.currentThread().getName()));</div><div class="line">            channel.read(buffer, channel, <span class="keyword">new</span> Reader(buffer));</div><div class="line">            serverChannel.accept(serverChannel, <span class="keyword">new</span> Acceptor());</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exception, AsynchronousServerSocketChannel serverChannel)</span> </span>&#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(exception);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Reader</span> <span class="keyword">implements</span> <span class="title">CompletionHandler</span>&lt;<span class="title">Integer</span>, <span class="title">AsynchronousSocketChannel</span>&gt; </span>&#123;</div><div class="line">        </div><div class="line">        <span class="keyword">private</span> ByteBuffer buffer;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Reader</span><span class="params">(ByteBuffer buffer)</span></span>&#123;</div><div class="line">            <span class="keyword">this</span>.buffer = buffer;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Integer result, AsynchronousSocketChannel channel)</span></span>&#123;</div><div class="line">            System.out.println(String.format(<span class="string">"read: name: %s"</span>, Thread.currentThread().getName()));</div><div class="line">            <span class="keyword">if</span>(result != <span class="keyword">null</span> &amp;&amp; result &lt; <span class="number">0</span>)&#123;</div><div class="line">                <span class="keyword">try</span>&#123;</div><div class="line">                  channel.close();</div><div class="line">                  <span class="keyword">return</span>;</div><div class="line">                &#125;<span class="keyword">catch</span>(IOException ignore)&#123;&#125;</div><div class="line">            &#125;</div><div class="line">            buffer.flip();</div><div class="line">            channel.write(buffer, channel, <span class="keyword">new</span> Writer(buffer));</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exception, AsynchronousSocketChannel channel)</span></span>&#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(exception);</div><div class="line">        &#125;                    </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Writer</span> <span class="keyword">implements</span> <span class="title">CompletionHandler</span>&lt;<span class="title">Integer</span>, <span class="title">AsynchronousSocketChannel</span>&gt; </span>&#123;</div><div class="line">    </div><div class="line">        <span class="keyword">private</span> ByteBuffer buffer;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Writer</span><span class="params">(ByteBuffer buffer)</span></span>&#123;</div><div class="line">            <span class="keyword">this</span>.buffer = buffer;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Integer result, AsynchronousSocketChannel channel)</span> </span>&#123;</div><div class="line">            System.out.println(String.format(<span class="string">"write: name: %s"</span>, Thread.currentThread().getName()));</div><div class="line">            buffer.clear();</div><div class="line">            channel.read(buffer, channel, <span class="keyword">new</span> Reader(buffer));</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exception, AsynchronousSocketChannel channel)</span> </span>&#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(exception);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException</span>&#123;</div><div class="line">        <span class="keyword">new</span> AsyncEchoServer().start();</div><div class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</div><div class="line">            Thread.sleep(<span class="number">1000L</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://YDDMAX.github.io/2017/06/03/负载均衡/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yunzhu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YDDMAX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/03/负载均衡/" itemprop="url">
                  负载均衡
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-03T21:15:10+08:00">
                2017-06-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/technology/" itemprop="url" rel="index">
                    <span itemprop="name">technology</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h1><blockquote>
<p>DNS负责提供域名解析服务，当访问某个站点时，实际上首先需要通过该站点域名的DNS服务器来获取域名指向的IP地址，在这一过程中，DNS服务器完成了域名到IP地址的映射，同样，这样映射也可以是一对多的，这时候，DNS服务器便充当了负载均衡调度器，它就像http重定向转换策略一样，将用户的请求分散到多台服务器上，但是它的实现机制完全不同。</p>
</blockquote>
<p>下图展示百度有三个IP地址：<br><img src="http://oqxil93b6.bkt.clouddn.com/images/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/baidu-dns.png" alt="百度DNS"></p>
<ul>
<li><strong>优点:</strong></li>
</ul>
<ol>
<li>可以根据用户IP来进行智能解析。DNS服务器可以在所有可用的A记录中寻找离用记最近的一台服务器。</li>
<li>动态DNS：在每次IP地址变更时，及时更新DNS服务器。当然，因为缓存，一定的延迟不可避免。</li>
</ol>
<ul>
<li><strong>缺点:</strong></li>
</ul>
<ol>
<li>没有用户能直接看到DNS解析到了哪一台实际服务器，加服务器运维人员的调试带来了不便。</li>
<li>策略的局限性。例如你无法将HTTP请求的上下文引入到调度策略中，而在前面介绍的基于HTTP重定向的负载均衡系统中，调度器工作在HTTP层面，它可以充分理解HTTP请求后根据站点的应用逻辑来设计调度策略，比如根据请求不同的URL来进行合理的过滤和转移。</li>
<li>如果要根据实际服务器的实时负载差异来调整调度策略，这需要DNS服务器在每次解析操作时分析各服务器的健康状态，对于DNS服务器来说，这种自定义开发存在较高的门槛，更何况大多数站点只是使用第三方DNS服务。</li>
<li>DNS记录缓存，各级节点的DNS服务器不同程序的缓存会让你晕头转向。</li>
<li>基于以上几点，DNS服务器并不能很好地完成工作量均衡分配，最后，是否选择基于DNS的负载均衡方式完全取决于你的需要。</li>
</ol>
<h1 id="HTTP重定向"><a href="#HTTP重定向" class="headerlink" title="HTTP重定向"></a>HTTP重定向</h1><blockquote>
<p>当http代理（比如浏览器）向web服务器请求某个URL后，web服务器可以通过http响应头信息中的Location标记来返回一个新的URL。这意味着HTTP代理需要继续请求这个新的URL，完成自动跳转。</p>
</blockquote>
<ol>
<li>吞吐率限制<br>主站点服务器的吞吐率平均分配到了被转移的服务器。现假设使用RR（Round Robin）调度策略，子服务器的最大吞吐率为1000reqs/s，那么主服务器的吞吐率要达到3000reqs/s才能完全发挥三台子服务器的作用，那么如果有100台子服务器，那么主服务器的吞吐率可想而知得有大？相反，如果主服务的最大吞吐率为6000reqs/s，那么平均分配到子服务器的吞吐率为2000reqs/s，而现子服务器的最大吞吐率为1000reqs/s，因此就得增加子服务器的数量，增加到6个才能满足。</li>
<li>重定向访问深度不同<br>有的重定向一个静态页面，有的重定向相比复杂的动态页面，那么实际服务器的负载差异是不可预料的，而主站服务器却一无所知。因此整站使用重定向方法做负载均衡不太好。</li>
</ol>
<p>我们需要权衡转移请求的开销和处理实际请求的开销，前者相对于后者越小，那么重定向的意义就越大，例如下载。你可以去很多镜像下载网站试下，会发现基本下载都使用了Location做了重定向。</p>
<h1 id="LVS（四层）"><a href="#LVS（四层）" class="headerlink" title="LVS（四层）"></a>LVS（四层）</h1><p>以下内容参考自<a href="http://www.tuicool.com/articles/vQzmi2" target="_blank" rel="external">LVS</a></p>
<h2 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h2><p>通过将请求报文的目标地址和目标端口修改为挑选出的某RS的RIP和PORT实现转发；<br>特点：</p>
<ol>
<li><strong>RIP和DIP必须在同一IP网络,且使用私网地址RS的网关应该指向DIP(保证响应报文必须经由VS)</strong></li>
<li><strong>请求和响应报文都要经由director转发；极高负载的场景中，Director可能会成为系统性能瓶颈</strong></li>
<li>支持端口映射</li>
<li>VS必须为Linux，RS可以是任意的OS</li>
<li><strong>调度器上需要两块网卡,一个配置vip 一个配置dip</strong></li>
</ol>
<p><img src="http://oqxil93b6.bkt.clouddn.com/nat.png" alt="NAT"></p>
<h2 id="FULLNAT"><a href="#FULLNAT" class="headerlink" title="FULLNAT"></a>FULLNAT</h2><p>非标准模型, ipvs默认不支持,ipvsadm也不支持。<br>NAT模式的扩展（阿里云的四层SLB使用的是此方式，因为此种方式下负载均衡器和后端服务器的部署不需要部署在同一网络内）<br>通过同时修改请求报文的源IP地址（cip–&gt;dip）和目标IP地址（vip –&gt; rip）实现转发<br>特点：</p>
<ol>
<li>调度器和后端服务器可以不在同一IP网络中</li>
<li>RS收到的请求报文的源IP为DIP，因此其响应报文将发送给DIP；</li>
<li>请求报文和响应报文都必须经由director；</li>
<li>支持端口映射；</li>
<li>RS可使用任意OS；    </li>
</ol>
<p><img src="http://oqxil93b6.bkt.clouddn.com/fullNAT.png" alt="fullNAT"></p>
<h2 id="DR"><a href="#DR" class="headerlink" title="DR"></a>DR</h2><p>直接路由<br>通过为请求报文重新封装一个MAC首部进行转发,源MAC是DIP所在接口的MAC,目标MAC是挑选出的某RS的RIP所在接口的MAC地址；IP首部不会发生变化（源IP为CIP，目标IP始终为VIP） </p>
<ol>
<li>RS跟Director必须在同一物理网络中；RS的网关必须不能指向DIP</li>
<li><strong>请求报文必须由Director调度，但响应报文必须不能经由Director</strong></li>
<li><strong>不支持端口映射</strong></li>
<li>各RS可以使用大多数的OS；一般是linux</li>
</ol>
<p>情形1: RIP DIP VIP 都在一个网络, 都是公网IP 地址</p>
<p><img src="http://oqxil93b6.bkt.clouddn.com/dr-same.png" alt="dr-same"></p>
<p>情形2: VIP 是公网ip地址, RIP,DIP是私有地址, 情况要复制些, RS要通过另一个路由出去</p>
<p><img src="http://oqxil93b6.bkt.clouddn.com/dr-no-same.png" alt="dr-nosame"></p>
<p>注意:<br>一个路由其可以有多个网络接口<br>一个交换机可以承载多个ip网络<br>所以路由器1和路由器2可以使用同一个<br>私网交换机和公网交换机也可以用同一个</p>
<h2 id="TUN"><a href="#TUN" class="headerlink" title="TUN"></a>TUN</h2><p>ip tunnel，ip隧道<br>转发方式：不修改请求报文的IP首部（源IP为CIP，目标IP为VIP），而是在原有的IP首部之外再次封装一个IP首部（源IP为DIP，目标IP为RIP）</p>
<ol>
<li>RIP，DIP，VIP全得是公网地址</li>
<li>RS的网关不能也不可能指向DIP</li>
<li>请求报文经由Director调度，但响应报文将直接发给CIP</li>
<li>不支持端口映射</li>
<li>RS的OS必须支持IP隧道功能；</li>
<li><strong>容易超出MTU,  弊端比较大</strong></li>
</ol>
<p><img src="http://oqxil93b6.bkt.clouddn.com/tunnel.png" alt="tunnel"></p>
<h1 id="反向代理（七层）"><a href="#反向代理（七层）" class="headerlink" title="反向代理（七层）"></a>反向代理（七层）</h1><p>这个肯定大家都有所接触，因为几乎所有主流的Web服务器都热衷于支持基于反向代理的负载均衡。<br>相比前面的HTTP重定向和DNS解析，反向代理的调度器扮演的是用户和实际服务器中间人的角色：</p>
<ol>
<li>任何对于实际服务器的HTTP请求都必须经过调度器</li>
<li>调度器必须等待实际服务器的HTTP响应，并将它反馈给用户（前两种方式不需要经过调度反馈，是实际服务器直接发送给用户）</li>
</ol>
<ul>
<li><strong>优点：</strong></li>
</ul>
<ol>
<li>调度策略丰富。例如可以为不同的实际服务器设置不同的权重，以达到能者多劳的效果。</li>
<li>对反向代理服务器的并发处理能力要求高，因为它工作在HTTP层面。</li>
<li>反向代理服务器可以监控后端服务器，比如系统负载、响应时间、是否可用、TCP连接数、流量等，从而根据这些数据调整负载均衡的策略。</li>
<li>反射代理服务器可以让用户在一次会话周期内的所有请求始终转发到一台特定的后端服务器上（粘滞会话），这样的好处一是保持session的本地访问，二是防止后端服务器的动态内存缓存的资源浪费。</li>
</ol>
<ul>
<li><strong>缺点：</strong><br>反向代理服务器进行转发操作本身是需要一定开销的，比如创建线程、与后端服务器建立TCP连接、接收后端服务器返回的处理结果、分析HTTP头部信息、用户空间和内核空间的频繁切换等，虽然这部分时间并不长，但是当后端服务器处理请求的时间非常短时，转发的开销就显得尤为突出。例如请求静态文件，更适合使用前面介绍的基于DNS的负载均衡方式。<h1 id="硬件"><a href="#硬件" class="headerlink" title="硬件"></a>硬件</h1>一般工作在四层。<br>性能较高，但是价格昂贵。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://YDDMAX.github.io/2017/06/03/架构的八荣八耻和20个能力/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yunzhu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YDDMAX">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/03/架构的八荣八耻和20个能力/" itemprop="url">
                  架构的八荣八耻和20个能力
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-03T20:27:20+08:00">
                2017-06-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/technology/" itemprop="url" rel="index">
                    <span itemprop="name">technology</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://oqxil93b6.bkt.clouddn.com/images/%E6%9E%B6%E6%9E%84%E7%9A%84%E5%85%AB%E8%8D%A3%E5%85%AB%E8%80%BB%E5%92%8C20%E4%B8%AA%E8%83%BD%E5%8A%9B/barongbachi.png" alt="架构的八荣八耻"></p>
<hr>
<p><img src="http://oqxil93b6.bkt.clouddn.com/images/%E6%9E%B6%E6%9E%84%E7%9A%84%E5%85%AB%E8%8D%A3%E5%85%AB%E8%80%BB%E5%92%8C20%E4%B8%AA%E8%83%BD%E5%8A%9B/architecture-ability.png" alt="此处输入图片的描述"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="yunzhu" />
          <p class="site-author-name" itemprop="name">yunzhu</p>
           
              <p class="site-description motion-element" itemprop="description">code rush</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="" target="_blank" title="WeChat">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  WeChat
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="" target="_blank" title="QQ">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  QQ
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yunzhu</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  

  

  

</body>
</html>
